language: node_js
os: linux
dist: focal
node_js: [14, 16, 18]

cache: false

git:
  # required to enable symlinks on windows
  symlinks: true

addons:
  apt:
    packages:
      # Ubuntu 16+ does not install this dependency by default, so we need to install it ourselves
      - libgconf-2-4

install:
  - yarn && yarn run build
script: yarn run ci

jobs:
  include:
    - stage: test
      os: windows
      env:
        - YARN_GPG=no
      script: |
        yarn workspace @appland/appmap jest --runTestsByPath \
          tests/unit/agentInstall/commandRunner.spec.ts \
          tests/unit/agentInstall/gradleInstaller.spec.ts \
        && yarn workspace @appland/scanner jest --runTestsByPath \
          test/cli/scan.spec.ts

    - stage: deploy
      if: branch != main
      script: yarn run chromatic

    - stage: deploy
      if: branch = main
      script: |
        yarn run chromatic --auto-accept-changes \
        && yarn run build-native \
        && yarn run semantic-release
