#!/usr/bin/env ruby

require 'fileutils'

revision = ARGV[0]
no_test = true if ARGV[1..-1].member?('--no-test')

cli_dir = Dir.pwd

sys_command = ->(cmd, env = nil) do
  Array(cmd).each do |c|
    args = [ env, c ].compact
    p args
    system *args or raise "Command failed: #{c}"
  end
end

node_version = `node -v`
raise "Node version should be 16, got #{node_version}" unless node_version.index('v16.')

Dir.chdir File.expand_path('~/source/appland/appland')
appland_dir = Dir.pwd

required_ruby_version = File.read('.ruby-version').strip
ruby_version = `ruby -v`
raise "Ruby version must be #{required_ruby_version}, is #{ruby_version}" unless ruby_version.index(required_ruby_version)

sys_command.call [
  "git checkout #{revision}",
]

unless no_test
  sys_command.call 'git lfs track "*.tar"' \
    unless File.read('.gitattributes').index('*.tar filter=lfs diff=lfs merge=lfs -text')

  env = `bundle exec rake dev:db`.split("\n").select { |line| line.index('=') }.map { |line| k, v = line.split('='); [ k['export '.length..-1], v] }.to_h

  FileUtils.rm_rf 'tmp/appmap'
  FileUtils.mkdir_p 'tmp/appmap/rspec'
  FileUtils.mkdir_p '.appmap/archive/full'

  sys_command.call [
    'npm install',
    './bin/webpack',
    'psql -U postgres -h localhost -c "create database appland_test" || true',
    'rails db:migrate',
    'rails db:test:prepare',
    'bundle exec rspec'
  ], env.merge('RAILS_ENV' => 'test', 'DISABLE_SPRING' => 'true')
end

Dir.chdir cli_dir

system "node ./built/src/cli.js archive"
