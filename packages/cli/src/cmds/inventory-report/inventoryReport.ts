import yargs from 'yargs';
import { verbose } from '../../utils';
import { handleWorkingDirectory } from '../../lib/handleWorkingDirectory';
import { readFile, writeFile } from 'fs/promises';
import generateReport from './Reporter';
import { warn } from 'console';
import { cwd } from 'process';
import { join } from 'path';
import { Report } from '../inventory/Report';
import assert from 'assert';
import loadAppMapConfig from '../../lib/loadAppMapConfig';
import buildReporter from './Reporter';

export const command = 'inventory-report <report-json-file> [output-file]';
export const describe = 'Generate a report document describing the current state of a repository.';

export const builder = (args: yargs.Argv) => {
  args.positional('report-json-file', {
    type: 'string',
    describe: `JSON report file to read. This file is generated by the 'inventory' command.`,
    demandOption: true,
  });

  args.option('directory', {
    describe: 'program working directory',
    type: 'string',
    alias: 'd',
  });

  args.positional('template-name', {
    type: 'string',
    describe: `Template name.`,
    default: 'welcome',
    choices: ['welcome', 'summary'],
    alias: 't',
  });

  args.positional('output-file', {
    type: 'string',
    describe: `Markdown output file. If not specified, the report is written to stdout.`,
    demandOption: true,
  });

  args.option('source-url', {
    describe: `Base URL to link to a source file. The relative path to the source file will be added to the URL path.`,
    type: 'string',
  });

  args.option('appmap-url', {
    describe: `Base URL to link to AppMaps. A 'path' parameter will be added with the relative path from the report directory to the AppMap JSON file.`,
    type: 'string',
  });

  return args.strict();
};

export const handler = async (argv: any) => {
  verbose(argv.verbose);
  const { directory } = argv;
  handleWorkingDirectory(directory);

  const { reportJsonFile, outputFile, templateName, appmapUrl, sourceUrl } = argv;
  assert(reportJsonFile);
  assert(templateName);

  const appmapConfig = await loadAppMapConfig();
  if (!appmapConfig) throw new Error('Unable to load appmap.yml');

  const report: Report = JSON.parse(await readFile(reportJsonFile, 'utf-8'));

  const reporter = buildReporter(templateName, appmapUrl, sourceUrl);
  const reportMD = await reporter.generateReport(report, appmapConfig);
  if (outputFile) {
    await writeFile(outputFile, reportMD);
    warn(`Report written to ${join(cwd(), outputFile)}`);
  } else {
    console.log(reportMD);
  }
};
